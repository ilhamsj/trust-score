networks:
  universe:
    external: true

services:
  payload:
    image: node:22.17.0-alpine
    container_name: payload
    working_dir: /app/
    command: >
      sh -c "
      corepack enable && 
      corepack prepare pnpm@latest --activate &&
      pnpm config set store-dir /pnpm/store &&
      pnpm install &&
      pnpm run dev"
    restart: unless-stopped
    volumes:
      - .:/app
      - ~/Library/pnpm/store:/pnpm/store
      - /app/node_modules
      - /app/.next
    ports:
      - 3000:3000
    environment:
      # Application
      - APP_DEBUG=${APP_DEBUG:-false}
      - APP_NAME=${APP_NAME:-Payload}
      - APP_URL=${APP_URL:-http://localhost:3000}
      - APP_SECRET=${APP_SECRET:-dummies}
      # Database
      - DATABASE_URI=${DATABASE_URI:-mongodb://root:root@mongo:27017/trust-score}
      # SMTP Configuration (defaults to mailpit on port 1025 with STARTTLS + auth)
      - SMTP_HOST=${SMTP_HOST:-mailpit}
      - SMTP_PORT=${SMTP_PORT:-1025}
      - SMTP_USER=${SMTP_USER:-root}
      - SMTP_PASS=${SMTP_PASS:-root}
      - SMTP_FROM_ADDRESS=${SMTP_FROM_ADDRESS:-info@payloadcms.com}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-Payload}
      - SMTP_SECURE=${SMTP_SECURE:-false}
      - SMTP_IGNORE_TLS=${SMTP_IGNORE_TLS:-false}
      # Google OAuth
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      # Jobs
      - JOBS_DELETE_ON_COMPLETE=${JOBS_DELETE_ON_COMPLETE:-false}
    networks:
      - universe

  mongo:
    image: mongo:latest
    container_name: mongo
    restart: unless-stopped
    environment:
      - MONGO_INITDB_ROOT_USERNAME
      - MONGO_INITDB_ROOT_PASSWORD
    networks:
      - universe

  mongo-express:
    image: mongo-express
    container_name: mongo-express
    restart: unless-stopped
    environment:
      - ME_CONFIG_MONGODB_URL=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongo:27017/?authSource=admin
      - ME_CONFIG_BASICAUTH_ENABLED=false
    ports:
      - 8081:8081
    networks:
      - universe

  # docker run -d --name some-clickhouse-server --ulimit nofile=262144:262144 clickhouse/clickhouse-server
  # docker run -it --rm --network=container:some-clickhouse-server --entrypoint clickhouse-client clickhouse/clickhouse-server
  clickhouse-server:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse-server
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    environment:
        CLICKHOUSE_USER: "default"
        CLICKHOUSE_PASSWORD: "default"
    volumes:
      - ./data/clickhouse/logs:/var/log/clickhouse-server
    networks:
      - universe
    ports:
      - "8123:8123"   # HTTP interface
      - "9010:9000"   # host port 9010 â†’ container port 9000 (hindari bentrok)

  clickhouse-client:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse-client
    entrypoint: clickhouse-client
    network_mode: "service:clickhouse-server"
    stdin_open: true
    tty: true